<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Sky4 by wangfakang</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Sky4</h1>
        <p class="header">ngx_http_accounting_module的解析</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/sky4/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/wangfakang/sky4/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/wangfakang/sky4">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/wangfakang">wangfakang</a></p>


      </header>
      <section>
        <p><code>对NGX_HTTP_ACCOUNTTING_MODULE的分析：
</code></p>

<h1>
<a id="内容" class="anchor" href="#%E5%86%85%E5%AE%B9" aria-hidden="true"><span class="octicon octicon-link"></span></a>内容：</h1>

<h2>
<a id="一配置说明" class="anchor" href="#%E4%B8%80%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E" aria-hidden="true"><span class="octicon octicon-link"></span></a>一：配置说明</h2>

<h2>
<a id="二openlog函数解析" class="anchor" href="#%E4%BA%8Copenlog%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>二：openlog函数解析</h2>

<h2>
<a id="三syslog函数解析" class="anchor" href="#%E4%B8%89syslog%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>三：syslog函数解析</h2>

<h2>
<a id="四细节注意点" class="anchor" href="#%E5%9B%9B%E7%BB%86%E8%8A%82%E6%B3%A8%E6%84%8F%E7%82%B9" aria-hidden="true"><span class="octicon octicon-link"></span></a>四：细节注意点</h2>

<h2>
<a id="五日志各字段含义" class="anchor" href="#%E4%BA%94%E6%97%A5%E5%BF%97%E5%90%84%E5%AD%97%E6%AE%B5%E5%90%AB%E4%B9%89" aria-hidden="true"><span class="octicon octicon-link"></span></a>五：日志各字段含义</h2>

<h2>
<a id="六执行流程" class="anchor" href="#%E5%85%AD%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>六：执行流程</h2>

<h1>
<a id="一配置说明-" class="anchor" href="#%E4%B8%80%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E-" aria-hidden="true"><span class="octicon octicon-link"></span></a>一.配置说明： </h1>

<div class="highlight highlight-nginx"><pre>    http{
        <span class="pl-k">http_accounting</span>  on;   <span class="pl-c"># turn on accounting function</span>
        ...
        <span class="pl-k">server</span> {
            <span class="pl-k">server_name</span> example.com;
            <span class="pl-k">http_accounting_id</span>  accounting_id_str;   <span class="pl-c"># set accounting_id based on server</span>
            ...
            <span class="pl-k">location</span> <span class="pl-en">/ </span>{ 
                <span class="pl-k">http_accounting_id</span>  accounting_id_str;    <span class="pl-c"># set accounting_id based on location</span>
                ...
            }
        }
    } </pre></div>

<p>上面的配置就启用了ngx_http_accountting的功能．那么该模块的功能是啥恩?该模块可以作为不同server级别location级别的流量统计，　　　
启动nginx后，日志会记录到系统日志，/var/log/message，类似:      </p>

<pre><code>May 1 17:32:25 localhost NgxAccounting: pid:195|from:1368783525|to:13683555|accounting_id:test|requests:30|bytes_out:882066|200:30
May 1 17:53:45 localhost NgxAccounting: pid:196|from:1368784635|to:13684665|accounting_id:test|requests:1|bytes_out:4087|200:1

</code></pre>

<p>当然也可以配置独立的log来进行存储：　　　</p>

<pre><code>echo "syslog.*                /var/log/syslog" &gt;&gt;  /etc/syslog.conf　　　　　　　　　　　

service syslog restart
</code></pre>

<h1>
<a id="二openlog函数的解析" class="anchor" href="#%E4%BA%8Copenlog%E5%87%BD%E6%95%B0%E7%9A%84%E8%A7%A3%E6%9E%90" aria-hidden="true"><span class="octicon octicon-link"></span></a>二.openlog函数的解析：</h1>

<pre><code>void openlog(const char*ident ,int option,int facility)    
参数一：ident：表示的字符串会加载到每一行的日志信息当中    
参数二：表示一些设置选项    
参数说明:    
LOG_CONS    如果将信息发送给syslogd守护进程时发生错误，直接将相关信息输出到终端    
LOG_NDELAY  立即打开与系统日志的连接（通常情况下，只有在产生第一条日志信息的情况下才会打开与日志系统的连接）     
LOG_NOWAIT  在记录日志信息时，不等待可能的子进程的创建    
LOG_ODELAY  类似于LOG_NDELAY参数，与系统日志的连接只有在syslog函数调用时才会创建    

参数说明    
LOG_PERROR  在将信息写入日志的同时，将信息发送到标准错误输出（POSIX.1-2001不支持该参数）   
LOG_PID 每条日志信息中都包括进程号   


参数三：facility表示rsyslog.conf中前面所配置的，意思表示日志信息 的来源  类型    
facility参数  syslog.conf中对应的facility取值   
LOG_KERN    kern    
LOG_USER    user   
LOG_MAIL    mail    
LOG_DAEMON  daemon   
LOG_AUTH    auth    
LOG_SYSLOG  syslog   
LOG_LPR lpr   
LOG_NEWS    news   
LOG_UUCP    uucp   
LOG_CRON    cron   
LOG_AUTHPRIV    authpriv    
LOG_FTP ftp   
LOG_LOCAL0～LOG_LOCAL7 local0～local7    
</code></pre>

<h1>
<a id="三其次是syslog函数-" class="anchor" href="#%E4%B8%89%E5%85%B6%E6%AC%A1%E6%98%AFsyslog%E5%87%BD%E6%95%B0-" aria-hidden="true"><span class="octicon octicon-link"></span></a>三.其次是：syslog函数 </h1>

<pre><code>原型：     
void syslog(int priority,const char*format,…)    
参数一：priority表示消息的级别    
priority参数  syslog.conf中对应的level取值    
LOG_EMERG   emerg 表示最紧急的信息   
LOG_ALERT   alert 紧急信息    
LOG_CRIT    crit 重要信息      
LOG_ERR err 错误信息    
LOG_WARNING warning    
LOG_NOTICE  notice 普通重要信息    
LOG_INFO    info 通知性消息     
LOG_DEBUG    

LOG_NONO    debug    

nono  没有重要性 不记录任何日志信息    
参数二：表示消息的格式   之后是所要发送的信息      
</code></pre>

<h1>
<a id="四特别注意点---" class="anchor" href="#%E5%9B%9B%E7%89%B9%E5%88%AB%E6%B3%A8%E6%84%8F%E7%82%B9---" aria-hidden="true"><span class="octicon octicon-link"></span></a>四.特别注意点:   </h1>

<pre><code>
在syslog的配置文件中:    
   在进行配置什么来源以及什么级别的日志  写入什么文件当中,  在文件路径的前面加"-"减号的时候:其含义是先将其写入缓存,然后在写入磁盘文件.
这样可以提高性能,但是有些不安全  由于有可能某个时候机器宕机了,则机器中缓存的数据就丢失了.
</code></pre>

<h1>
<a id="五输出日志的各字段的含义" class="anchor" href="#%E4%BA%94%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97%E7%9A%84%E5%90%84%E5%AD%97%E6%AE%B5%E7%9A%84%E5%90%AB%E4%B9%89" aria-hidden="true"><span class="octicon octicon-link"></span></a>五.输出日志的各字段的含义：</h1>

<pre><code>
The output contains a list of k/v for the accounting metrics, in the sequence of:          
key     meaning     
pid     pid of nginx worker process   
from / to   metric was collected between these timestamps    
accounting_id   identify for the accounting unit, you name it with http_accounting_id directive       
requests    count of total requests processed    
bytes_in    total bytes receiverd by the server     
bytes_out   total bytes send out by the server    
latency_ms  a sum of $request_time, in millisecond        
upstream_latency_ms     a sum of $upstream_response_time, in millisecond               
200 / 302 / 400 / 404 / 500 ...     count of requests which response is with http code 200/302/400/404/500, etc     
</code></pre>

<h1>
<a id="六内部执行过程" class="anchor" href="#%E5%85%AD%E5%86%85%E9%83%A8%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>六.内部执行过程：　</h1>

<pre><code>其中WORK_PROCESS_INTERVAL 默认值是30    

ngx_http_accounting_work_process_init     
          |   
         \|/     
ngx_add_timer(write_out_ev,WORK_PROCESS_INTERVAL*(rand()%200))  最开始最多等6秒钟    
          |    
         \|/    
write_out_ev有一个handler,其指向work_process_alarm_handler       
          |     
         \|/    
ngx_http_accounting_hash_iterate   ngx_add_timer(write_out_ev,WORK_PROCESS_INTERVAL*1000)  后续每隔30秒输出一次    
          |      
         \|/   
上面函数主要就是调用openlog  syslog其相应函数进行写syslog.       

</code></pre>

<h2>
<a id="有问题反馈" class="anchor" href="#%E6%9C%89%E9%97%AE%E9%A2%98%E5%8F%8D%E9%A6%88" aria-hidden="true"><span class="octicon octicon-link"></span></a>有问题反馈</h2>

<p>在使用中有任何问题，欢迎反馈给我，可以用以下联系方式跟我交流</p>

<ul>
<li>邮件(1031379296#qq.com, 把#换成@)</li>
<li>QQ: 1031379296</li>
<li>weibo: <a href="http://weibo.com/u/2786211992/home">@王发康</a>
</li>
</ul>

<h2>
<a id="感激" class="anchor" href="#%E6%84%9F%E6%BF%80" aria-hidden="true"><span class="octicon octicon-link"></span></a>感激</h2>

<h3>
<a id="chunshengsteratgmailcom" class="anchor" href="#chunshengsteratgmailcom" aria-hidden="true"><span class="octicon octicon-link"></span></a>chunshengsterATgmail.com</h3>

<h2>
<a id="关于作者" class="anchor" href="#%E5%85%B3%E4%BA%8E%E4%BD%9C%E8%80%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>关于作者</h2>

<h3>
<a id="linuxnginxgolangcc爱好者" class="anchor" href="#linuxnginxgolangcc%E7%88%B1%E5%A5%BD%E8%80%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>Linux\nginx\golang\c\c++爱好者</h3>

<h3>
<a id="欢迎一起交流--一起学习" class="anchor" href="#%E6%AC%A2%E8%BF%8E%E4%B8%80%E8%B5%B7%E4%BA%A4%E6%B5%81--%E4%B8%80%E8%B5%B7%E5%AD%A6%E4%B9%A0" aria-hidden="true"><span class="octicon octicon-link"></span></a>欢迎一起交流  一起学习#</h3>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		          <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("nginx http　accounting 流量统计");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
